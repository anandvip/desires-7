<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desire Tracker</title>
    <style>
       * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .input-methods {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .mic-btn {
            background: #48bb78;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mic-btn.recording {
            background: #f56565;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .desire-form {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: grid;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #4a5568;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .desires-list {
            display: grid;
            gap: 20px;
        }

        .desire-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: move;
            position: relative;
        }

        .desire-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .desire-card::before {
            content: '‚ãÆ‚ãÆ';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            font-size: 20px;
            cursor: move;
        }

        .desire-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-left: 30px;
        }

        .desire-title {
            font-size: 1.25em;
            font-weight: 600;
            color: #2d3748;
        }

        .desire-priority {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .priority-high { background: #fed7d7; color: #c53030; }
        .priority-medium { background: #feebc8; color: #c05621; }
        .priority-low { background: #c6f6d5; color: #2f855a; }

        .desire-description {
            color: #4a5568;
            margin-bottom: 15px;
            line-height: 1.5;
            padding-left: 30px;
        }

        .state-notes {
            margin: 15px 0;
            padding: 15px 30px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .state-note {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .state-note:last-child {
            border-bottom: none;
        }

        .state-note-date {
            font-size: 0.85em;
            color: #718096;
            margin-right: 10px;
        }

        .state-note-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .state-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .state-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            font-size: 14px;
            background: #4a5568;
            color: white;
            border-radius: 6px;
        }

        .state-btn:hover {
            background: #2d3748;
        }

        .state-input-group {
            display: none;
            margin-top: 10px;
        }

        .state-input-group.active {
            display: block;
        }

        .state-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .desire-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
            padding-left: 30px;
        }

        .desire-date {
            color: #718096;
            font-size: 14px;
        }

        .delete-btn {
            background: #fc8181;
            padding: 8px 16px;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #f56565;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .recognition-status {
            text-align: center;
            margin: 10px 0;
            font-style: italic;
            color: #718096;
        }
    </style>
</head>
<body>
    <div class="container">
          <header class="header">
            <h1>‚ú® Desire Tracker</h1>
            <p>Transform your dreams into reality</p>
        </header>
         <section class="auth-section">
            <div id="userProfile" class="user-profile">
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="Profile">
                    <div class="user-details">
                        <span id="userName" class="user-name"></span>
                        <span id="userEmail" class="user-email"></span>
                    </div>
                </div>
                <button id="signOutBtn" class="btn btn-danger">
                    üö™ Sign Out
                </button>
            </div>

            <button id="signInBtn" class="btn btn-google">
                <img src="https://www.google.com/favicon.ico" alt="Google" width="20" height="20">
                Sign in with Google
            </button>
        </section>

        <div class="input-methods">
            <button id="micBtn" class="mic-btn">
                üé§ Start Dictation
            </button>
            <button id="showFormBtn">
                ‚úèÔ∏è Manual Entry
            </button>
        </div>
          <main id="mainContent" style="display: none;">
        <form class="desire-form" id="desireForm">
            <div class="form-group">
                <label for="desireTitle">What's your desire?</label>
                <input type="text" id="desireTitle" required placeholder="Enter your desire...">
            </div>

            <div class="form-group">
                <label for="desireDescription">Description</label>
                <textarea id="desireDescription" placeholder="Describe your desire in detail..."></textarea>
            </div>

            <div class="form-group">
                <label for="desirePriority">Priority Level</label>
                <select id="desirePriority">
                    <option value="low">Low Priority</option>
                    <option value="medium">Medium Priority</option>
                    <option value="high">High Priority</option>
                </select>
            </div>

            <button type="submit">Add Desire</button>
        </form>
         <div id="desiresList" class="desires-list"></div>
          </main>
    </div>

    <div id="speechModal" class="modal">
        <div class="modal-content">
            <h2>Speech Recognition</h2>
            <p id="recognitionStatus" class="recognition-status">Listening...</p>
            <div id="recognizedText"></div>
            <button id="confirmSpeech">Confirm</button>
            <button id="cancelSpeech">Cancel</button>
        </div>
    </div>
      <div id="toastContainer" class="toast-container"></div>
        
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            onAuthStateChanged
        } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js';
        import {
            getFirestore,
            collection,
            addDoc,
            deleteDoc,
            doc,
            setDoc,
            query,
            where,
            orderBy,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCLfBy9R_tL8WPRJpmKZMcy70OzhId9V1w",
            authDomain: "desires-b59a7.firebaseapp.com",
            projectId: "desires-b59a7",
            storageBucket: "desires-b59a7.firebasestorage.app",
            messagingSenderId: "942109661123",
            appId: "1:942109661123:web:84f2532a442f9d49bb8f76"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Utility functions
        const utils = {
            showLoading: () => document.getElementById('loadingOverlay').classList.add('active'),
            hideLoading: () => document.getElementById('loadingOverlay').classList.remove('active'),

            formatDate: (dateString) => {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },
            showToast: (message, type = 'success') => {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = 'toast';

                const icon = type === 'success' ? '‚úÖ' :
                    type === 'error' ? '‚ùå' :
                        'üîî';

                toast.innerHTML = `
                    <span>${icon}</span>
                    <span>${message}</span>
                `;

                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        };

        // DesireManager class to handle data operations
        class DesireManager {
            constructor() {
                this.desires = [];
                this.currentUser = null;
                this.db = getFirestore();
                this.localStorageKey = 'desires';
            }

             // Local Storage Functions
            loadDesiresFromLocalStorage() {
                try {
                    const storedDesires = localStorage.getItem(this.localStorageKey);
                    if (storedDesires) {
                         this.desires = JSON.parse(storedDesires);
                        console.log("Desires loaded from local storage", this.desires)
                    } else {
                        this.desires = [];
                    }
                } catch (error) {
                    console.error('Error loading from local storage:', error);
                    this.desires = [];
                }
            }

            saveDesiresToLocalStorage() {
                try {
                    localStorage.setItem(this.localStorageKey, JSON.stringify(this.desires));
                } catch (error) {
                    console.error('Error saving to local storage:', error);
                }
            }

            async addDesire(desireData) {
                if (!this.currentUser) throw new Error('User not authenticated');

                const newDesire = {
                    ...desireData,
                    id : Math.random().toString(36).substring(2, 15), // Generate a temporary id for local storage usage
                    userId: this.currentUser.uid,
                    stateNotes: [], // Initialize empty array for state notes
                    createdAt: new Date().toISOString()
                };

                this.desires = [...this.desires, newDesire];
                this.saveDesiresToLocalStorage();

                try {
                    const docRef = await addDoc(collection(db, 'users', this.currentUser.uid, 'desires'), newDesire);
                   // Update local desire with the firebase id
                    const addedDesireIndex = this.desires.findIndex((desire) => desire.id === newDesire.id);
                     if(addedDesireIndex > -1) {
                         this.desires[addedDesireIndex] = {...this.desires[addedDesireIndex], id: docRef.id}
                         this.saveDesiresToLocalStorage();
                         console.log("Firestore id added to local storage object")
                     }
                    await this.loadDesires(); // Refresh desires to ensure sync
                    return true;
                } catch (error) {
                    console.error('Error adding desire to firebase:', error);
                    throw error;
                }
            }

            async deleteDesire(id) {
                if (!this.currentUser) throw new Error('User not authenticated');

                 this.desires = this.desires.filter(desire => desire.id !== id);
                 this.saveDesiresToLocalStorage();

                try {
                    await deleteDoc(doc(db, 'users', this.currentUser.uid, 'desires', id));
                    await this.loadDesires();
                    return true;
                } catch (error) {
                    console.error('Error deleting desire from firebase:', error);
                    throw error;
                }
            }

           async loadDesires() {
              if (!this.currentUser) {
                    console.log('No user logged in');
                    this.desires = [];
                    return;
                }

                try {
                    // Log authentication state
                    console.log('Current User:', {
                        uid: this.currentUser.uid,
                        email: this.currentUser.email,
                        isAnonymous: this.currentUser.isAnonymous,
                        emailVerified: this.currentUser.emailVerified
                    });

                    // Reference to the desires collection
                    const desiresRef = collection(db, `users/${this.currentUser.uid}/desires`);
                    console.log('Collection path:', `users/${this.currentUser.uid}/desires`);

                    // Query the collection
                    const q = query(desiresRef, orderBy('createdAt', 'desc'));

                    const snapshot = await getDocs(q);
                    console.log('Query snapshot:', {
                        empty: snapshot.empty,
                        size: snapshot.size
                    });

                    //Map data from firebase, and update
                   const firebaseDesires = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                   const localDesires = this.desires

                    // Sync logic here
                    this.desires = this.syncDesires(localDesires, firebaseDesires);
                   this.saveDesiresToLocalStorage();

                } catch (error) {
                    console.error('Detailed error:', {
                        code: error.code,
                        message: error.message,
                        name: error.name,
                        stack: error.stack,
                        path: `users/${this.currentUser?.uid}/desires`
                    });
                    throw error;
                }
            }

            syncDesires(localDesires, firebaseDesires) {
                const syncedDesires = [...firebaseDesires];
                localDesires.forEach(localDesire => {
                    const firebaseMatch = firebaseDesires.find(firebaseDesire => firebaseDesire.id === localDesire.id);

                    if (!firebaseMatch) {
                        syncedDesires.push(localDesire);
                    } else {
                        // Update local object with firebase object if different
                        if (JSON.stringify(localDesire) != JSON.stringify(firebaseMatch)) {
                            const matchIndex = syncedDesires.findIndex(obj => obj.id === localDesire.id)
                           syncedDesires[matchIndex] = {...localDesire, ...firebaseMatch}
                        }

                    }
                });
                return syncedDesires
             }
            setCurrentUser(user) {
                this.currentUser = user;
            }
             addStateNote(desireId, note) {
                const desire = this.desires.find(d => d.id === desireId);
                if (desire) {
                    desire.stateNotes.unshift({
                        id: Date.now(),
                        text: note,
                        date: new Date().toISOString()
                    });
                    this.saveDesiresToLocalStorage();
                    return true;
                }
                return false;
            }

           deleteStateNote(desireId, noteId) {
                const desire = this.desires.find(d => d.id === desireId);
                if (desire) {
                    desire.stateNotes = desire.stateNotes.filter(note => note.id !== noteId);
                    this.saveDesiresToLocalStorage();
                    return true;
                }
                return false;
            }

        }

        // UIManager class to handle the user interface
        class UIManager {
             constructor(desireManager) {
                this.desireManager = desireManager;
                this.form = document.getElementById('desireForm');
                this.list = document.getElementById('desiresList');
                this.micBtn = document.getElementById('micBtn');
                this.showFormBtn = document.getElementById('showFormBtn');
                this.speechModal = document.getElementById('speechModal');
                this.recognitionStatus = document.getElementById('recognitionStatus');
                this.recognizedText = document.getElementById('recognizedText');
                this.confirmSpeech = document.getElementById('confirmSpeech');
                this.cancelSpeech = document.getElementById('cancelSpeech');
                  this.userProfile = document.getElementById('userProfile');
                    this.signInBtn = document.getElementById('signInBtn');
                    this.signOutBtn = document.getElementById('signOutBtn');
                this.isRecording = false;
                this.activeRecordingId = null;
                this.recognition = null;
                 this.initializeEventListeners();
                this.initializeSpeechRecognition();
            }

             initializeEventListeners() {
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                this.signInBtn.addEventListener('click', () => this.handleSignIn());
                this.signOutBtn.addEventListener('click', () => this.handleSignOut());
                this.micBtn.addEventListener('click', () => this.toggleSpeechRecognition());
                this.showFormBtn.addEventListener('click', () => this.toggleFormVisibility());
                this.cancelSpeech.addEventListener('click', () => this.closeModal());
            }


             initializeSpeechRecognition() {
                if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;

                    this.recognition.onstart = () => {
                        this.isRecording = true;
                        this.updateRecordingUI(true);
                          this.recognitionStatus.textContent = 'Listening...';
                           this.recognizedText.innerHTML = '';
                        this.speechModal.classList.add('active');

                    };

                    this.recognition.onend = () => {
                        this.isRecording = false;
                         this.updateRecordingUI(false);
                          this.recognitionStatus.textContent = 'Finished.';
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                         this.stopSpeechRecognition();
                         this.closeModal();
                    };

                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                         for (let i = event.resultIndex; i < event.results.length; i++) {
                             if (event.results[i].isFinal) {
                                 finalTranscript += event.results[i][0].transcript + ' ';
                             }
                         }
                         if (finalTranscript) {
                            this.recognizedText.innerHTML = `<p>${finalTranscript}</p>`
                           this.confirmSpeech.onclick = () => {
                            if (this.activeRecordingId) {
                              this.addStateNote(this.activeRecordingId, finalTranscript.trim())
                            } else {
                                document.getElementById('desireTitle').value = finalTranscript.trim();
                            }
                              this.closeModal();
                             this.stopSpeechRecognition();
                           }
                         }
                     }
                } else {
                    this.micBtn.style.display = 'none';
                    console.warn('Speech recognition not supported');
                }
            }

            updateAuthUI(user) {
                if (user) {
                    this.userProfile.classList.add('active');
                    document.getElementById('userAvatar').src = user.photoURL;
                    document.getElementById('userName').textContent = user.displayName;
                    document.getElementById('userEmail').textContent = user.email;
                    this.signInBtn.style.display = 'none';
                    this.mainContent.style.display = 'block';
                } else {
                    this.userProfile.classList.remove('active');
                    this.signInBtn.style.display = 'flex';
                    this.mainContent.style.display = 'none';
                }
            }
            updateRecordingUI(isRecording) {
                const button = this.activeRecordingId
                    ? document.querySelector(`button[data-mic="${this.activeRecordingId}"]`)
                    : this.micBtn;

                if (button) {
                    if (isRecording) {
                        button.classList.add('recording');
                        button.textContent = this.activeRecordingId ? 'üé§ Stop Recording' : 'üé§ Stop Dictation';
                    } else {
                        button.classList.remove('recording');
                        button.textContent = this.activeRecordingId ? 'üé§ Add Voice Note' : 'üé§ Start Dictation';
                    }
                }
            }

            async toggleSpeechRecognition(desireId = null) {
                try {
                    if (this.isRecording) {
                        this.stopSpeechRecognition();
                        this.closeModal();
                    } else {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.activeRecordingId = desireId;
                        this.startSpeechRecognition();
                    }
                } catch (error) {
                    console.error('Microphone permission denied:', error);
                    alert('Please allow microphone access to use speech recognition.');
                }
            }


           closeModal(){
              this.speechModal.classList.remove('active');
              this.stopSpeechRecognition();
          }

            startSpeechRecognition() {
                if (this.recognition) {
                    this.recognition.start();
                }
            }

            stopSpeechRecognition() {
                if (this.recognition) {
                    this.recognition.stop();
                    this.isRecording = false;
                    this.activeRecordingId = null;
                }
            }

             async handleSignIn() {
                try {
                     utils.showLoading();
                     const result = await signInWithPopup(auth, provider);
                     utils.showToast(`Welcome, ${result.user.displayName}! üéâ`);
                    return true;
                   } catch (error) {
                     console.error('Sign-in error:', error);
                     utils.showToast(
                       error.code === 'auth/popup-closed-by-user'
                         ? 'Sign-in cancelled'
                         : 'Failed to sign in. Please try again.',
                       'error'
                     );
                     return false;
                   } finally {
                   utils.hideLoading();
                 }
            }

             async handleSignOut() {
                try {
                     utils.showLoading();
                   await signOut(auth);
                   utils.showToast('Successfully signed out üëã');
                  this.desireManager.desires = [];
                } catch (error) {
                  console.error('Sign-out error:', error);
                  utils.showToast('Failed to sign out', 'error');
                } finally {
                  utils.hideLoading();
               }
            }

           addStateNote(desireId, note) {
                if (this.desireManager.addStateNote(desireId, note)){
                    this.renderDesires();
                }
           }
          deleteStateNote(desireId, noteId) {
                if(this.desireManager.deleteStateNote(desireId, noteId)){
                     this.renderDesires();
                }

            }

             handleSubmit(e) {
                e.preventDefault();

                const desire = {
                    title: document.getElementById('desireTitle').value,
                    description: document.getElementById('desireDescription').value,
                    priority: document.getElementById('desirePriority').value
                 };
                 
                this.desireManager.addDesire(desire).then(() => {
                   this.renderDesires();
                    this.form.reset();
                 });
            }
            toggleFormVisibility() {
                this.form.style.display = this.form.style.display === 'none' ? 'grid' : 'none';
            }

            renderDesires() {
                 if (this.desireManager.desires.length === 0) {
                    this.list.innerHTML = `
                        <div class="empty-state">
                            <h3>No desires added yet</h3>
                            <p>Start by adding your first desire using voice or text input!</p>
                        </div>
                    `;
                    return;
                }
                this.list.innerHTML = this.desireManager.desires
                    .map(desire => `
                        <div class="desire-card"
                             draggable="true"
                             data-id="${desire.id}">
                            <div class="desire-header">
                                <h3 class="desire-title">${desire.title}</h3>
                                <span class="desire-priority priority-${desire.priority}">
                                    ${desire.priority.charAt(0).toUpperCase() + desire.priority.slice(1)}
                                </span>
                            </div>
                            <p class="desire-description">${desire.description || 'No description provided'}</p>

                            <div class="state-notes">
                                <h4>State Notes</h4>
                                ${desire.stateNotes.map(note => `
                                    <div class="state-note">
                                        <span>${note.text}</span>
                                        <div class="state-note-actions">
                                            <span class="state-note-date">${utils.formatDate(note.date)}</span>
                                            <button onclick="event.stopPropagation(); app.uiManager.deleteStateNote('${desire.id}', '${note.id}')">
                                                ‚ùå
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}

                                <div class="state-actions">
                                     <button class="state-btn"
                                            data-mic="${desire.id}"
                                            onclick="event.stopPropagation(); app.uiManager.toggleStateInput('${desire.id}', 'voice')">
                                        üé§ Add Voice Note
                                    </button>
                                    <button class="state-btn"
                                           onclick="event.stopPropagation(); app.uiManager.toggleStateInput('${desire.id}', 'text')">
                                        ‚úèÔ∏è Add Text Note
                                    </button>
                                </div>

                                <div class="state-input-group" data-desire="${desire.id}">
                                    <input type="text"
                                           class="state-input"
                                           placeholder="Enter your state note..."
                                           onkeypress="if(event.key === 'Enter') {
                                               app.uiManager.addStateNote('${desire.id}', this.value);
                                               this.value = '';
                                               this.parentElement.classList.remove('active');
                                           }">
                                </div>
                            </div>

                            <div class="desire-footer">
                                <span class="desire-date">${utils.formatDate(desire.createdAt)}</span>
                                <button class="delete-btn" onclick="event.stopPropagation(); app.uiManager.deleteDesire('${desire.id}')">                                    Delete
                                </button>
                            </div>
                        </div>
                    `)
                    .join('');
                 this.initializeDragAndDrop();
            }

            toggleStateInput(desireId, inputType) {
                const inputGroup = document.querySelector(`.state-input-group[data-desire="${desireId}"]`);
                if (inputGroup) {
                   if (inputType === 'voice') {
                       this.toggleSpeechRecognition(desireId);
                   } else {
                       inputGroup.classList.toggle('active');
                       if (inputGroup.classList.contains('active')) {
                           inputGroup.querySelector('input').focus();
                       }
                   }
                }
            }
             initializeDragAndDrop() {
                this.list.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('desire-card')) {
                        e.target.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', e.target.dataset.id);
                    }
                });

                this.list.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('desire-card')) {
                        e.target.classList.remove('dragging');
                    }
                });

                this.list.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = this.getDragAfterElement(this.list, e.clientY);
                    const draggable = document.querySelector('.dragging');
                    if (afterElement) {
                        this.list.insertBefore(draggable, afterElement);
                    } else {
                        this.list.appendChild(draggable);
                    }
                });

                 this.list.addEventListener('drop', (e) => {
                     e.preventDefault();
                    this.updateDesireOrder();
                 });
            }

             getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.desire-card:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            updateDesireOrder() {
                const cards = [...this.list.querySelectorAll('.desire-card')];
                const newOrder = cards.map(card => {
                  return this.desireManager.desires.find(desire => desire.id === card.dataset.id);
                });
                this.desireManager.desires = newOrder;
                this.desireManager.saveDesiresToLocalStorage();
            }


             deleteDesire(id) {
                this.desireManager.deleteDesire(id).then(() => {
                      this.renderDesires();
                });
            }
        }

         class AuthManager {
            constructor(desireManager, uiManager) {
                this.desireManager = desireManager;
                this.uiManager = uiManager;
            }

             async handleSignIn() {
                 try {
                     utils.showLoading();
                    const result = await signInWithPopup(auth, provider);
                     utils.showToast(`Welcome, ${result.user.displayName}! üéâ`);
                    return true;
                } catch (error) {
                     console.error('Sign-in error:', error);
                     utils.showToast(
                       error.code === 'auth/popup-closed-by-user'
                         ? 'Sign-in cancelled'
                         : 'Failed to sign in. Please try again.',
                       'error'
                     );
                   return false;
                }  finally {
                  utils.hideLoading();
                }
            }

             async handleSignOut() {
                try {
                      utils.showLoading();
                   await signOut(auth);
                   utils.showToast('Successfully signed out üëã');
                   return true;
                 } catch (error) {
                    console.error('Sign-out error:', error);
                    utils.showToast('Failed to sign out', 'error');
                    return false;
                } finally {
                  utils.hideLoading();
                }
            }
        }
        // Main Application class
         class DesireTracker {
            constructor() {
                this.desireManager = new DesireManager();
                this.uiManager = new UIManager(this.desireManager);
                this.authManager = new AuthManager(this.desireManager, this.uiManager)
                this.initializeAuth();
            }

             initializeAuth() {
                onAuthStateChanged(auth, async (user) => {
                    console.log('Auth state changed:', user ? {
                        uid: user.uid,
                        email: user.email,
                        provider: user.providerData[0]?.providerId
                    } : 'No user');
                     this.desireManager.setCurrentUser(user);
                     this.uiManager.updateAuthUI(user);

                    if (user) {
                        try {
                             utils.showLoading();
                           this.desireManager.loadDesiresFromLocalStorage();
                           await this.desireManager.loadDesires();
                            this.uiManager.renderDesires();
                         } catch (error) {
                            console.error('Load error:', error);
                           utils.showToast('Failed to load desires', 'error');
                        } finally {
                           utils.hideLoading();
                        }
                    } else {
                        this.desireManager.desires = [];
                        this.uiManager.renderDesires();
                    }
                });
            }
        }

        // Initialize and expose the application globally
        window.app = new DesireTracker();

        // Event Listener for Auth button
        const signInBtn = document.getElementById('signInBtn');
         signInBtn.addEventListener('click', async () => {
            await app.authManager.handleSignIn();
         });

          const signOutBtn = document.getElementById('signOutBtn');
            signOutBtn.addEventListener('click', async () => {
           await app.authManager.handleSignOut();
         });

    </script>
</body>
</html>
